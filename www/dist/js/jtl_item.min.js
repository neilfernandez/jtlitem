/*
 * JTL Item v1.1 - http://apex.world/plugins/
 *
 * Licensed under MIT License (MIT)
 * Jorge Rimblas Â© 2017-2020
*/
$.widget("tk.jtl_item",{options:{lang:"en",lang_codes:["en","fr","es"],messages:null,itemName:"",fieldSize:30,fieldRows:5,fieldMaxLength:80,dialogTitle:null},_ig$:null,_grid:null,_topApex:apex.util.getTopApex(),_initGridConfig:function(){console.log("_initGridConfig"),this._ig$=this._item$.closest(".a-IG"),this._ig$.length>0&&(this._grid=this._ig$.interactiveGrid("getViews").grid)},_resetFocus:function(){var e=this;if(this._grid){var t=this._grid.model.getRecordId(this._grid.view$.grid("getSelectedRecords")[0]),a=this._ig$.interactiveGrid("option").config.columns.filter(function(t){return t.staticId===e.options.itemName})[0];this._grid.view$.grid("gotoCell",t,a.name),this._grid.focus()}else e._elements.$displayInput.focus()},_createPrivateStorage:function(){this._values={apexItemId:"",controlsId:"",fieldSize:30,fieldMaxLength:80,dataJSON:{},curr_lang_index:0,languages:{},tagMap:{},messages:$.parseJSON(this.options.messages),totalLanguages:0,disabled:!1,newRecord:!1,signalChange:!1},this._elements={$window:{},$document:{},$body:{},$displayInput:{},$fieldset:{},$mlsButton:{},$dialog:{},$dialogContent:{},$saveButton:{},$cancelButton:{},$buttonContainer:{}}},_create:function(){var e=this;console.log("_create"),console.log(e.options.itemName),e._item$=$("#"+e.options.itemName),e._createPrivateStorage(),e._values.apexItemId=e.options.itemName,e._values.controlsId=e._values.apexItemId+"_fieldset",e._initElements(),e._initBaseElements(),e._values.languages=JSON.parse(e.options.lang_codes),e._values.totalLanguages=e._values.languages.length,e._initDataJSON(),e._initLanguageMap(),e._values.curr_lang_index=function(e,t){var a=null,n=-1;for(a=0;e.length>a&&-1==n;a+=1)e[a].l===t&&(n=a);return n}(e._values.dataJSON,e.options.lang),e._elements.$displayInput.bind("change",{uiw:e},e._syncHiddenField),e._elements.$document.bind("apexbeforepagesubmit",{uiw:e},e._syncHiddenField),e._elements.$mlsButton.bind("click",{uiw:e},e._handleOpenClick),apex.debug.message(4,"Registering with apex.widget.initPageItem: "+e._elements.itemName),e._initApexItem()},_initApexItem:function(){var e=this;apex.item.create(e.options.itemName,{setValue:function(t,a){console.log("setValue:",t,a),a||!t||0===t.length?(console.log("empty pValue"),e._elements.$displayInput(a),e._values.dataJSON=t,e.element.data("value",t)):(console.log("NOT empty pValue"),e._elements.$displayInput(a),e._values.dataJSON=t,e.element.data("value",t)),e._syncHiddenField()},getValue:function(){return JSON.stringify(e.element.data("value"))},setFocus:function(){e._elements.$displayInput.focus()},enable:function(){e.enable()},disable:function(){e.disable()}}),apex.item(e.options.itemName).callbacks.displayValueFor=function(){return e._elements.$displayInput.val()}},_initElements:function(){this._elements.$window=$(window),this._elements.$document=$(document),this._elements.$body=$(document.body),this._elements.$dialog=$("div.jtlitem-dialog")},_initDialogElements:function(){this._elements.$dialog=$("div.jtlitem-dialog"),this._elements.$dialogContent=$("div.jtlitem-content"),this._elements.$saveButton=$("button.jtlitem-save-button"),this._elements.$cancelButton=$("button.jtlitem-cancel-button")},_initBaseElements:function(){var e=this;console.log("element",e.element),e._elements.$displayInput=$("#"+e._values.apexItemId),e._values.fieldSize="TEXT"===e.options.itemType?e._elements.$displayInput.attr("size"):e._elements.$displayInput.attr("cols"),"TEXTAREA"===e.options.itemType&&(e._values.fieldRows=e._elements.$displayInput.attr("rows")),e._values.fieldMaxLength=e._elements.$displayInput.attr("maxlength"),e._elements.$fieldset=$("#"+e._values.controlsId),e._elements.$mlsButton=e._elements.$fieldset.find("button.jtlitem-modal-open")},_initDataJSON:function(){var e=[],t=this.element.data("value")||{};console.log({input_data:t}),apex.jQuery.isEmptyObject(t)?(console.log("empty value"),this._values.languages.forEach(function(t){e.push({l:t,tl:""})}),this.element.data("value",e),this._values.dataJSON=e,this._values.newRecord=!0):(console.log("have a value"),this._values.dataJSON=t,this._values.newRecord=!1)},_syncHiddenField:function(e){var t,a;if(a=(t=void 0!==e?e.data.uiw:this)._values.curr_lang_index,t._values.newRecord)for(var n=t._values.totalLanguages-1;n>=0;n--)t._values.dataJSON[n].tl=t._elements.$displayInput.val();else t._values.dataJSON[a].tl=t._elements.$displayInput.val();t.element.data("value",t._values.dataJSON),t._initLanguageMap()},_initDialogButtons:function(){this._elements.$cancelButton.bind("click",{uiw:this},this._handleCancelButtonClick),this._elements.$saveButton.bind("click",{uiw:this},this._handleSaveButtonClick)},_handleCancelButtonClick:function(e){e.data.uiw._elements.$dialog.dialog("close")},_handleSaveButtonClick:function(e){var t,a=e.data.uiw;a._elements.$dialogContent.find(".jtlitem-value").each(function(e,n){apex.debug.message(4,e+"("+n.dataset.lang+"):"+n.value),a._values.dataJSON[e].l=n.dataset.lang,a._values.dataJSON[e].tl=n.value,a._values.curr_lang_index==e&&(t=n.value)}),a._initLanguageMap(),a._elements.$displayInput.val(t),a.element.data("value",a._values.dataJSON),a._values.newRecord=!1,a._elements.$dialog.dialog("close")},_signalChange:function(){var e=this._elements.$displayInput[0];apex.jQuery(e).trigger("change")},_handleOpenClick:function(e){var t=e.data.uiw;t._syncHiddenField(e),t._showDialog()},_initLanguageMap:function(){var e,t=null;for(e=this._values.dataJSON,this._values.tagMap={},t=0;e.length>t;t+=1)this._values.tagMap[e[t].l]=e[t].tl},_hasTag:function(e){return this._values.tagMap[e]},_showDialog:function(){var e,t,a=this,n=a._values.curr_lang_index;a._initGridConfig(),console.log("_grid:",a._grid),e='<table class="t-Report-report" summary="Available Translations">\n <tr>\n  <th class="t-Report-colHead">'+a._values.messages.languageLabel+'</th>  <th class="t-Report-colHead u-tL">'+a._values.messages.languageValue+"</th> </tr>\n <tr>\n",$.each(a._values.languages,function(t,l){e+=' <tr>\n  <td class="t-Report-cell t-Form-inputContainer u-tC'+(n==t?" selected":"")+'">'+apex.util.escapeHTMLAttr(l)+'</td>  <td class="t-Report-cell t-Form-inputContainer u-tL'+(n==t?" selected":"")+'">',"TEXT"===a.options.itemType?e+='    <input type="text" class="text_field apex-item-text jtlitem-value" data-lang="'+l+'" value="'+apex.util.escapeHTMLAttr(a._hasTag(l))+'" size="'+a._values.fieldSize+'" maxlength="'+a._values.fieldMaxLength+'"></td>':e+='    <textarea class="textarea apex-item-textarea jtlitem-value" data-lang="'+l+'" cols="'+a._values.fieldSize+'" rows="'+a._values.fieldRows+'" maxlength="'+a._values.fieldMaxLength+'">'+apex.util.escapeHTMLAttr(a._hasTag(l))+"</textarea>",e+=" </tr>\n"}),e+="</table>\n",t='<div class="jtlitem-dialog"><div class="jtlitem-container ui-widget">\n  <div class="jtlitem-button-container">\n     <button class="jtlitem-cancel-button t-Button">       <span class="t-Button-label">'+a._values.messages.cancelButton+'</span>     </button>\n     <button class="jtlitem-save-button t-Button t-Button--hot">       <span class="t-Button-label">'+a._values.messages.applyChanges+'</span>       <span class="t-Icon t-Icon--right fa fa-check"></span>     </button>\n  </div>\n  <div class="jtlitem-content">\n'+e+"  </div>\n</div></div>\n",a._elements.$body.append(t),a._initElements(),a._elements.$dialog.dialog({closeOnEscape:!0,title:a.options.dialogTitle,autoResize:!0,minWidth:400,minHeight:250,width:"auto",height:"auto",modal:!0,position:{my:"left",at:"left center",of:a._elements.$displayInput[0]},open:function(){a._initDialogElements(),a._initDialogButtons(),a._elements.$dialogContent.find("input").first().focus()},close:function(){$(this).dialog("destroy"),a._elements.$dialog.remove(),a._elements.$document.find("div.jtlitem-dialog").remove(),a._resetFocus()}}).on("keydown",function(e){e.keyCode===$.ui.keyCode.ESCAPE&&a._elements.$dialog.dialog("close"),e.stopPropagation()})},disable:function(){!1===this._values.disabled&&(this._elements.$displayInput.attr("disabled","disabled"),this._elements.$mlsButton.attr("disabled","disabled").unbind("click",this._handleOpenClick)),this._values.disabled=!0},enable:function(){!0===this._values.disabled&&(this._elements.$displayInput.removeAttr("disabled"),this._elements.$mlsButton.removeAttr("disabled").bind("click",{uiw:this},this._handleOpenClick),this._values.disabled=!1)}});